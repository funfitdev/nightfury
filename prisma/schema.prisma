generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// IDENTITY & AUTHENTICATION
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  username      String?   @unique
  name          String?
  avatarUrl     String?
  isActive      Boolean   @default(true)
  isSuperAdmin  Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Authentication
  accounts      Account[]
  sessions      Session[]
  credentials   Credential?

  // Authorization
  userRoles     UserRole[]

  // Multi-tenancy
  memberships   OrganizationMember[]
  ownedOrgs     Organization[]       @relation("OrgOwner")

  // Security
  auditLogs     AuditLog[]
  apiKeys       ApiKey[]

  @@index([email])
  @@index([username])
  @@index([isActive])
}

model Credential {
  id             String   @id @default(cuid())
  userId         String   @unique
  hashedPassword String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  provider          String   // e.g., "google", "github", "facebook"
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  idToken           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model VerificationToken {
  id         String              @id @default(cuid())
  identifier String              // email or phone
  token      String              @unique
  type       VerificationTokenType
  expiresAt  DateTime
  createdAt  DateTime            @default(now())

  @@unique([identifier, type])
  @@index([token])
}

enum VerificationTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  MAGIC_LINK
  TWO_FACTOR
}

// =============================================================================
// AUTHORIZATION - ROLE-BASED ACCESS CONTROL (RBAC)
// =============================================================================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  isSystem    Boolean  @default(false) // System roles can't be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  userRoles   UserRole[]
  orgRoles    OrganizationRole[]

  @@index([name])
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "users:read", "posts:write", "orders:delete"
  displayName String
  description String?
  resource    String   // e.g., "users", "posts", "orders"
  action      String   // e.g., "create", "read", "update", "delete", "manage"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([name])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
}

// =============================================================================
// MULTI-TENANCY / ORGANIZATIONS
// =============================================================================

model Organization {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  description String?
  logoUrl     String?
  website     String?
  ownerId     String
  status      OrganizationStatus @default(ACTIVE)
  settings    Json?            // Flexible org-level settings
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  owner   User                 @relation("OrgOwner", fields: [ownerId], references: [id])
  members OrganizationMember[]
  roles   OrganizationRole[]
  invites OrganizationInvite[]

  @@index([slug])
  @@index([ownerId])
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

model OrganizationMember {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  roles        OrganizationRole[] @relation("MemberRoles")

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
}

model OrganizationRole {
  id        String   @id @default(cuid())
  orgId     String
  roleId    String
  createdAt DateTime @default(now())

  organization Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role         Role                 @relation(fields: [roleId], references: [id], onDelete: Cascade)
  members      OrganizationMember[] @relation("MemberRoles")

  @@unique([orgId, roleId])
  @@index([orgId])
}

model OrganizationInvite {
  id        String       @id @default(cuid())
  orgId     String
  email     String
  roleId    String?      // Role to assign on acceptance
  token     String       @unique
  status    InviteStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, email])
  @@index([token])
  @@index([email])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// =============================================================================
// API KEYS (for programmatic access)
// =============================================================================

model ApiKey {
  id           String    @id @default(cuid())
  userId       String
  name         String
  keyHash      String    @unique // Store hashed version of the key
  keyPrefix    String    // First 8 chars for identification, e.g., "mwm_live_"
  permissions  String[]  // Array of permission names
  lastUsedAt   DateTime?
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@index([keyPrefix])
}

// =============================================================================
// AUDIT LOG (for security and compliance)
// =============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // e.g., "user.login", "user.logout", "role.assigned"
  resource   String?  // e.g., "User", "Organization"
  resourceId String?
  metadata   Json?    // Additional context
  ipAddress  String?
  userAgent  String?
  status     String   @default("success") // "success", "failure"
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
}
